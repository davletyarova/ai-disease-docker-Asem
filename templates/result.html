{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Symptom Analysis Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body { background-color: #f2f7ff; }
      .card-custom {
        background-color: #3498db;
        color: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        border-radius: 15px;
        transition: transform 0.3s;
        cursor: pointer;
      }
      .card-custom:hover { transform: scale(1.05); }
      .modal-content { border-radius: 15px; }
      .modal-header {
        background-color: #3498db;
        color: white;
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
      }
      .modal-body { font-size: 1rem; }
      .action-btns { margin-top: 40px; }
    </style>
  </head>

  <body class="container mt-5 mb-5">
    <h1 class="mb-4 text-center">Symptom Analysis Results</h1>

    {% if error %}
      <div class="alert alert-danger" role="alert">{{ error }}</div>
    {% else %}

    <!-- Section: Diagnosis -->
    <div id="disease-section">
      <div class="row justify-content-center">
        {% for disease, probability, description, recommendation in predictions %}
        <div class="col-md-4 mb-4">
          <div class="card card-custom text-center p-4" data-bs-toggle="modal" data-bs-target="#modal{{ forloop.counter }}">
            <h4 class="card-title">{{ disease }}</h4>
            <small class="text-light">Click for details</small>
          </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="modal{{ forloop.counter }}" tabindex="-1" aria-labelledby="exampleModalLabel{{ forloop.counter }}" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel{{ forloop.counter }}">{{ disease }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p><strong>Probability of the disease:</strong> {{ probability|floatformat:1 }} %</p>
                <p><strong>Description:</strong> {{ description }}</p>
                <p><strong>Recommendation:</strong> {{ recommendation }}</p>
                <p class="text-muted">âš¡ Preliminary assessment. Please consult a doctor.</p>
                <hr />
                <p><a href="https://www.google.com/search?q={{ disease|urlencode }}" target="_blank">ðŸ”— Search "{{ disease }}" on Google</a></p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Section: Accuracy Chart -->
    <div id="accuracy-section" style="display: none" class="mt-5">
      <h3 class="text-center mb-4">ðŸ“Š Accuracy of Supervised Models</h3>
      <canvas id="accuracyChart" width="400" height="200"></canvas>
    </div>

    {% if plot_paths %}
    <div class="row justify-content-center mt-5">
      {% for plot in plot_paths %}
      <div class="col-md-6 text-center mb-4">
        <img src="/{{ plot }}" alt="Prediction Chart" class="img-fluid rounded shadow" />
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Buttons -->
    <div class="text-center action-btns">
      <a href="{% url 'index' %}" class="btn btn-success btn-lg px-5 me-3">Return to form</a>
      <a href="{% url 'download_pdf' %}" class="btn btn-primary btn-lg px-5 me-3">Download PDF</a>
      <form method="post" action="{% url 'send_email_result' %}" class="d-inline">
        {% csrf_token %}
        <input type="email" name="email" placeholder="Enter email" class="form-control d-inline-block w-auto" required />
        <button type="submit" class="btn btn-warning btn-lg">Send to Email</button>
      </form>
    </div>

    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      function showSection(section) {
        document.getElementById("disease-section").style.display = section === "disease" ? "block" : "none";
        document.getElementById("accuracy-section").style.display = section === "accuracy" ? "block" : "none";
      }

      window.addEventListener("load", function () {
        const ctx = document.getElementById("accuracyChart");
        if (ctx) {
          const labels = {{ request.session.acc_labels|safe }};
          const data = {{ request.session.acc_data|safe }};
          new Chart(ctx, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [{
                label: "Accuracy (%)",
                data: data,
                backgroundColor: "rgba(54, 162, 235, 0.6)"
              }]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100
                }
              }
            }
          });
        }
      });
    </script>
  </body>
</html>
